#!/bin/bash
# Custom git credential helper that uses different gh accounts based on directory

# Only handle 'get' operations
if [[ "$1" != "get" ]]; then
    exit 0
fi

# Check if gh is installed
if ! command -v gh &>/dev/null; then
    echo "error: gh CLI is not installed" >&2
    echo "Install it from: https://cli.github.com/" >&2
    exit 1
fi

# Read the credential request from stdin
input=$(cat)

# Check if we're in a paella directory (or the paella directory itself)
if [[ "$PWD" == /home/maxwell/code/paella || "$PWD" == /home/maxwell/code/paella/* ]]; then
    username="mPaella"
else
    username="maxwellfortney"
fi

# Get the token for the specific user
token=$(gh auth token -u "$username" 2>/dev/null)

if [[ -z "$token" ]]; then
    echo "error: GitHub account '$username' is not authenticated with gh CLI" >&2
    echo "Run: gh auth login" >&2
    exit 1
fi

# Parse the host from input
host=$(echo "$input" | grep "^host=" | cut -d= -f2)
protocol=$(echo "$input" | grep "^protocol=" | cut -d= -f2)

# Output credentials
echo "protocol=${protocol:-https}"
echo "host=${host:-github.com}"
echo "username=$username"
echo "password=$token"
